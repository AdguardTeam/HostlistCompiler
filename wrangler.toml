name = "adblock-compiler"
main = "worker/worker.ts"
compatibility_date = "2024-01-01"
workers_dev = true

[build]
command = ""

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 1
persist = true

# KV Namespaces
[[kv_namespaces]]
binding = "COMPILATION_CACHE"
id = "7772628dc4ae46fbb145a811d2de351e"

[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "5dc36da36d9142cc9ced6c56328898ee"

[[kv_namespaces]]
binding = "METRICS"
id = "025c3f10527c46c0be559f299bdba994"

# R2 Storage
[[r2_buckets]]
binding = "FILTER_STORAGE"
bucket_name = "adblock-compiler-r2-storage"

[vars]
COMPILER_VERSION = "0.7.9"

[assets]
directory = "./public"
binding = "ASSETS"

# Queues
[[queues.producers]]
queue = "adblock-compiler-worker-queue"
binding = "ADBLOCK_COMPILER_QUEUE"

[[queues.producers]]
queue = "adblock-compiler-worker-queue-high-priority"
binding = "ADBLOCK_COMPILER_QUEUE_HIGH_PRIORITY"

[[queues.consumers]]
queue = "adblock-compiler-worker-queue"
max_batch_size = 10
max_batch_timeout = 5
dead_letter_queue = "adblock-compiler-dlq"

[[queues.consumers]]
queue = "adblock-compiler-worker-queue-high-priority"
max_batch_size = 5
max_batch_timeout = 2
dead_letter_queue = "adblock-compiler-dlq"

[dev]
port = 8787
local_protocol = "http"
enable_containers = false

# --- Disabled features (uncomment when ready) ---
# Containers: requires beta access
# [[containers]]
# class_name = "AdblockCompiler"
# image = "./Dockerfile"
# max_instances = 5
# instance_type = "basic"

# Durable Objects
# [[durable_objects.bindings]]
# class_name = "AdblockCompiler"
# name = "ADBLOCK_COMPILER"
# [[migrations]]
# new_sqlite_classes = ["AdblockCompiler"]
# tag = "v1"

# Tail Workers
# [[tail_consumers]]
# service = "adblock-compiler-tail"

# Analytics Engine
# [[analytics_engine_datasets]]
# binding = "ANALYTICS_ENGINE"
# dataset = "adguard-compiler-analytics-engine"

# [env.production]
# vars = { ENVIRONMENT = "production" }
# tail_consumers = [{ service = "adblock-compiler-tail" }]
