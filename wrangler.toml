name = "adblock-compiler"
main = "worker/worker.ts"
compatibility_date = "2024-01-01"

# Enable the Workers runtime
workers_dev = true

# Build configuration
[build]
command = ""

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 1
persist = true

# KV bindings for caching and rate limiting
[[kv_namespaces]]
binding = "COMPILATION_CACHE"
id = "7772628dc4ae46fbb145a811d2de351e"  # Create with: wrangler kv:namespace create COMPILATION_CACHE

[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "5dc36da36d9142cc9ced6c56328898ee"  # Create with: wrangler kv:namespace create RATE_LIMIT

[[kv_namespaces]]
binding = "METRICS"
id = "025c3f10527c46c0be559f299bdba994"  # Create with: wrangler kv:namespace create METRICS

# Optional: Add R2 bindings for storing filter lists
[[r2_buckets]]
binding = "FILTER_STORAGE"
bucket_name = "adblock-compiler-r2-storage"

[[containers]]
class_name = "AdblockCompiler"
image = "./Dockerfile"
max_instances = 5
instance_type = "basic"

[[durable_objects.bindings]]
class_name = "AdblockCompiler"
name = "ADBLOCK_COMPILER"

[[migrations]]
new_sqlite_classes = ["AdblockCompiler"]
tag = "v1"

# Environment variables
[vars]
COMPILER_VERSION = "0.6.97"

# Static assets configuration using modern assets
[assets]
directory = "./public"
binding = "ASSETS"

[[tail_consumers]]
service = "adblock-compiler-tail"

# Tail Workers - for log collection and observability
# Uncomment to enable tail worker (must be deployed separately first)
tail_consumers = [{ service = "adblock-compiler-tail" }]

# Development settings
[dev]
port = 8787
local_protocol = "http"
enable_containers = false  # Containers not supported on Windows - use WSL or deploy to test

# Production settings (optional)
[env.production]
vars = { ENVIRONMENT = "production" }
tail_consumers = [{ service = "adblock-compiler-tail" }]

[[analytics_engine_datasets]]
binding = "ANALYTICS_ENGINE"
dataset = "adguard-compiler-analytics-engine"
