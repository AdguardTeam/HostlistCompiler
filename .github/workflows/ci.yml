name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for provenance on JSR

jobs:
  # TODO: Re-enable linting after addressing existing lint issues
  # lint:
  #   name: Lint Code
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Deno
  #       uses: denoland/setup-deno@v1
  #       with:
  #         deno-version: v2.4

  #     - name: Run Deno lint
  #       run: deno task lint

  #     - name: Check formatting
  #       run: deno task fmt:check

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        deno-version: ['2.0', '2.4']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ matrix.deno-version }}

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/deno
          key: ${{ runner.os }}-deno-${{ hashFiles('deno.json', 'deno.lock') }}
          restore-keys: |
            ${{ runner.os }}-deno-

      - name: Run tests
        run: |
          # Deno 2.0-2.2 only support lockfile v4, but we use v5 (requires 2.3+)
          # Use --no-lock for Deno 2.0 to test runtime compatibility without strict lock
          if [ "${{ matrix.deno-version }}" = "2.0" ]; then
            deno test --allow-read --allow-write --allow-net --allow-env --unstable-kv --no-lock
          else
            deno task test
          fi

      - name: Run tests with coverage
        if: matrix.deno-version == '2.4'
        continue-on-error: true
        run: |
          deno task test:coverage
          deno coverage coverage --lcov --output=coverage.lcov

      - name: Upload coverage to Codecov
        if: matrix.deno-version == '2.4'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.lcov
          flags: unittests
          name: deno-${{ matrix.deno-version }}
          fail_ci_if_error: false
        continue-on-error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.4

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/deno
          key: ${{ runner.os }}-deno-typecheck-${{ hashFiles('deno.json', 'deno.lock') }}
          restore-keys: |
            ${{ runner.os }}-deno-typecheck-

      - name: Type check all files
        run: deno task check

  # TODO: Re-enable worker validation after fixing worker type issues
  # build:
  #   name: Validate Worker
  #   runs-on: ubuntu-latest
  #   needs: [test, type-check]
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Deno
  #       uses: denoland/setup-deno@v1
  #       with:
  #         deno-version: v2.4

  #     - name: Cache Deno dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cache/deno
  #         key: ${{ runner.os }}-deno-build-${{ hashFiles('deno.json', 'deno.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-deno-build-

  #     - name: Type check worker
  #       run: |
  #         cd examples/cloudflare-worker
  #         deno check src/worker.ts

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.repository == github.event.repository.full_name && !github.event.repository.fork
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  publish-jsr:
    name: Publish to JSR
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.4

      - name: Publish to JSR
        run: deno publish --allow-dirty
        continue-on-error: true
        env:
          JSR_TOKEN: ${{ secrets.JSR_TOKEN }}

  deploy-worker:
    name: Deploy Worker
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: examples/cloudflare-worker
          command: deploy --no-versions

  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: hostlist-compiler-ui
          directory: examples/cloudflare-worker/public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: failure() && github.event_name == 'push'
    steps:
      - name: Send notification
        run: |
          echo "Build failed for commit ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"
