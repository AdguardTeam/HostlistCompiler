name: CI/CD Pipeline

on:
    push:
        branches: [master, main]
    pull_request:
        branches: [master, main]
    workflow_dispatch:

permissions:
    contents: read
    pull-requests: write
    id-token: write

jobs:
    lint:
        name: Lint Code
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/deno
                  key: ${{ runner.os }}-deno-lint-${{ hashFiles('deno.json') }}
                  restore-keys: |
                      ${{ runner.os }}-deno-lint-

            - name: Run Deno lint
              run: deno lint

            - name: Check formatting
              run: deno fmt --check

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/deno
                  key: ${{ runner.os }}-deno-test-${{ hashFiles('deno.json') }}
                  restore-keys: |
                      ${{ runner.os }}-deno-test-

            - name: Run tests
              run: deno test --allow-read --allow-write --allow-net --allow-env --unstable-kv

            - name: Run tests with coverage
              continue-on-error: true
              run: |
                  deno test --allow-read --allow-write --allow-net --allow-env --unstable-kv --coverage=coverage
                  deno coverage coverage --lcov --output=coverage.lcov

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              continue-on-error: true
              with:
                  files: ./coverage.lcov
                  flags: unittests
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    type-check:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.cache/deno
                  key: ${{ runner.os }}-deno-check-${{ hashFiles('deno.json') }}
                  restore-keys: |
                      ${{ runner.os }}-deno-check-

            - name: Type check main library
              run: deno check src/index.ts

    security:
        name: Security Scan
        runs-on: ubuntu-latest
        continue-on-error: true
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: fs
                  scan-ref: .
                  format: sarif
                  output: trivy-results.sarif

            - name: Upload Trivy results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              continue-on-error: true
              with:
                  sarif_file: trivy-results.sarif

    publish-jsr:
        name: Publish to JSR
        runs-on: ubuntu-latest
        needs: [lint, test, type-check]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Check if version already published
              id: version-check
              run: |
                  LOCAL_VERSION=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).version)")
                  PACKAGE_NAME=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).name)")
                  echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

                  HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://jsr.io/${PACKAGE_NAME}/${LOCAL_VERSION}/meta.json" || echo "000")

                  if [ "$HTTP_STATUS" = "200" ]; then
                    echo "Version $LOCAL_VERSION already published"
                    echo "should_publish=false" >> $GITHUB_OUTPUT
                  else
                    echo "Version $LOCAL_VERSION not found, will publish"
                    echo "should_publish=true" >> $GITHUB_OUTPUT
                  fi

            - name: Publish to JSR
              if: steps.version-check.outputs.should_publish == 'true'
              run: deno publish --allow-slow-types

    deploy-worker:
        name: Deploy Worker
        runs-on: ubuntu-latest
        needs: [lint, test, type-check]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        continue-on-error: true
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install dependencies
              working-directory: examples/cloudflare-worker
              run: npm install

            - name: Deploy to Cloudflare Workers
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  workingDirectory: examples/cloudflare-worker
                  command: deploy

    deploy-pages:
        name: Deploy Pages
        runs-on: ubuntu-latest
        needs: [lint, test, type-check]
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        continue-on-error: true
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy to Cloudflare Pages
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: hostlist-compiler-ui
                  directory: examples/cloudflare-worker/public
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}
