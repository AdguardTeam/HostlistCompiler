name: CI

on:
    push:
        branches: [master, main]
    pull_request:
        branches: [master, main]
    workflow_dispatch:

env:
    DENO_VERSION: '2.x'

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    ci:
        name: Lint, Test & Type Check
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: deno-${{ runner.os }}-${{ hashFiles('deno.json') }}
                  restore-keys: deno-${{ runner.os }}-

            - name: Lint
              run: deno lint

            - name: Format check
              run: deno fmt --check

            - name: Type check
              run: deno check src/index.ts

            - name: Test with coverage
              run: |
                  deno test --allow-read --allow-write --allow-net --allow-env --unstable-kv --coverage=coverage
                  deno coverage coverage --lcov --output=coverage.lcov

            - name: Upload coverage
              if: github.event_name == 'push'
              uses: codecov/codecov-action@v5
              continue-on-error: true
              with:
                  files: ./coverage.lcov
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    benchmark:
        name: Performance Benchmarks
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: deno-${{ runner.os }}-${{ hashFiles('deno.json') }}
                  restore-keys: deno-${{ runner.os }}-

            - name: Run benchmarks
              run: deno bench --allow-read --allow-write --allow-net --allow-env --json > benchmark-results.json

            - name: Upload benchmark results
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results-${{ github.sha }}
                  path: benchmark-results.json
                  retention-days: 90

            - name: Display results in summary
              if: github.event_name == 'pull_request'
              continue-on-error: true
              run: |
                  set -euo pipefail
                  echo "## Benchmark Results" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "Benchmark results saved as artifact for commit ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "<details><summary>View Results</summary>" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo '```json' >> "$GITHUB_STEP_SUMMARY"
                  RESULTS_FILE="benchmark-results.json"
                  MAX_BYTES=50000
                  if [ -f "$RESULTS_FILE" ]; then
                      FILE_SIZE=$(wc -c < "$RESULTS_FILE" || echo 0)
                      if [ "$FILE_SIZE" -le "$MAX_BYTES" ]; then
                          cat "$RESULTS_FILE" >> "$GITHUB_STEP_SUMMARY"
                      else
                          head -c "$MAX_BYTES" "$RESULTS_FILE" >> "$GITHUB_STEP_SUMMARY"
                          echo "" >> "$GITHUB_STEP_SUMMARY"
                          echo "" >> "$GITHUB_STEP_SUMMARY"
                          echo "...(output truncated in summary; full benchmark results are available in the uploaded artifact)..." >> "$GITHUB_STEP_SUMMARY"
                      fi
                  else
                      echo '{"error":"benchmark-results.json not found"}' >> "$GITHUB_STEP_SUMMARY"
                  fi
                  echo '```' >> "$GITHUB_STEP_SUMMARY"
                  echo "</details>" >> "$GITHUB_STEP_SUMMARY"

    security:
        name: Security Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
        steps:
            - uses: actions/checkout@v4

            - name: Run Trivy scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: fs
                  scan-ref: .
                  format: sarif
                  output: trivy-results.sarif
                  severity: 'CRITICAL,HIGH,MEDIUM'

            - name: Upload results
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              continue-on-error: true
              with:
                  sarif_file: trivy-results.sarif

    build:
        name: Build Artifacts
        runs-on: ubuntu-latest
        needs: ci
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Build CLI binary
              run: deno compile --allow-read --allow-write --allow-net --output=hostlist-compiler src/cli.ts

            - name: Upload CLI binary
              uses: actions/upload-artifact@v4
              with:
                  name: hostlist-compiler-linux-x64
                  path: hostlist-compiler
                  retention-days: 30

    docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: ci
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository }}
                  tags: |
                      type=raw,value=latest,enable={{is_default_branch}}
                      type=sha,prefix=
                      type=ref,event=branch

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    publish:
        name: Publish to JSR
        runs-on: ubuntu-latest
        needs: ci
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Publish
              run: |
                  set -euo pipefail
                  # Attempt to publish to JSR. Capture output so we can inspect errors.
                  if ! OUTPUT="$(deno publish --allow-slow-types 2>&1)"; then
                    echo "${OUTPUT}"
                    # Treat "version already exists" style errors as non-fatal to preserve
                    # existing behavior, but fail on all other errors.
                    if echo "${OUTPUT}" | grep -qiE 'version .*already (exists|published)'; then
                      echo "Version may already exist; treating this as a non-fatal condition."
                      exit 0
                    fi
                    echo "deno publish failed with an unexpected error."
                    exit 1
                  fi

    deploy-worker:
        name: Deploy Cloudflare Worker
        runs-on: ubuntu-latest
        needs: [ci, security]
        if: |
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
            vars.ENABLE_CLOUDFLARE_DEPLOY == 'true'
        permissions:
            contents: read
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.4

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/deno
          key: ${{ runner.os }}-deno-typecheck-${{ hashFiles('deno.json', 'deno.lock') }}
          restore-keys: |
            ${{ runner.os }}-deno-typecheck-

      - name: Type check all files
        run: deno task check

  # TODO: Re-enable worker validation after fixing worker type issues
  # build:
  #   name: Validate Worker
  #   runs-on: ubuntu-latest
  #   needs: [test, type-check]
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Deno
  #       uses: denoland/setup-deno@v1
  #       with:
  #         deno-version: v2.4

  #     - name: Cache Deno dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cache/deno
  #         key: ${{ runner.os }}-deno-build-${{ hashFiles('deno.json', 'deno.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-deno-build-

  #     - name: Type check worker
  #       run: |
  #         cd examples/cloudflare-worker
  #         deno check src/worker.ts

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.repository == github.event.repository.full_name && !github.event.repository.fork
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  publish-jsr:
    name: Publish to JSR
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.4

      - name: Check version change
        id: version-check
        run: |
          # Get local version from deno.json
          LOCAL_VERSION=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).version)")
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

          # Get package name from deno.json
          PACKAGE_NAME=$(deno eval "console.log(JSON.parse(Deno.readTextFileSync('deno.json')).name)")

          # Check if version exists on JSR
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://jsr.io/${PACKAGE_NAME}/${LOCAL_VERSION}/meta.json")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Version $LOCAL_VERSION already published to JSR"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Version $LOCAL_VERSION not found on JSR, will publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish to JSR
        if: steps.version-check.outputs.should_publish == 'true'
        run: |
          echo "Publishing version ${{ steps.version-check.outputs.local_version }} to JSR..."
          deno publish

  deploy-worker:
    name: Deploy Worker
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: examples/cloudflare-worker
          command: deploy --no-versions

  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: hostlist-compiler-ui
          directory: examples/cloudflare-worker/public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, type-check]
    if: failure() && github.event_name == 'push'
    steps:
      - name: Send notification
        run: |
          echo "Build failed for commit ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"
    ci:
        name: Lint, Test & Type Check
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: deno-${{ runner.os }}-${{ hashFiles('deno.json') }}
                  restore-keys: deno-${{ runner.os }}-

            - name: Lint
              run: deno lint

            - name: Format check
              run: deno fmt --check

            - name: Type check
              run: deno check src/index.ts

            - name: Test with coverage
              run: |
                  deno test --allow-read --allow-write --allow-net --allow-env --unstable-kv --coverage=coverage
                  deno coverage coverage --lcov --output=coverage.lcov

            - name: Upload coverage
              if: github.event_name == 'push'
              uses: codecov/codecov-action@v5
              continue-on-error: true
              with:
                  files: ./coverage.lcov
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    benchmark:
        name: Performance Benchmarks
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: deno-${{ runner.os }}-${{ hashFiles('deno.json') }}
                  restore-keys: deno-${{ runner.os }}-

            - name: Run benchmarks
              run: deno bench --allow-read --allow-write --allow-net --allow-env --json > benchmark-results.json

            - name: Upload benchmark results
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results-${{ github.sha }}
                  path: benchmark-results.json
                  retention-days: 90

            - name: Display results in summary
              if: github.event_name == 'pull_request'
              continue-on-error: true
              run: |
                  set -euo pipefail
                  echo "## Benchmark Results" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "Benchmark results saved as artifact for commit ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "<details><summary>View Results</summary>" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo '```json' >> "$GITHUB_STEP_SUMMARY"
                  RESULTS_FILE="benchmark-results.json"
                  MAX_BYTES=50000
                  if [ -f "$RESULTS_FILE" ]; then
                      FILE_SIZE=$(wc -c < "$RESULTS_FILE" || echo 0)
                      if [ "$FILE_SIZE" -le "$MAX_BYTES" ]; then
                          cat "$RESULTS_FILE" >> "$GITHUB_STEP_SUMMARY"
                      else
                          head -c "$MAX_BYTES" "$RESULTS_FILE" >> "$GITHUB_STEP_SUMMARY"
                          echo "" >> "$GITHUB_STEP_SUMMARY"
                          echo "" >> "$GITHUB_STEP_SUMMARY"
                          echo "...(output truncated in summary; full benchmark results are available in the uploaded artifact)..." >> "$GITHUB_STEP_SUMMARY"
                      fi
                  else
                      echo '{"error":"benchmark-results.json not found"}' >> "$GITHUB_STEP_SUMMARY"
                  fi
                  echo '```' >> "$GITHUB_STEP_SUMMARY"
                  echo "</details>" >> "$GITHUB_STEP_SUMMARY"

    security:
        name: Security Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write
        steps:
            - uses: actions/checkout@v4

            - name: Run Trivy scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: fs
                  scan-ref: .
                  format: sarif
                  output: trivy-results.sarif
                  severity: 'CRITICAL,HIGH,MEDIUM'

            - name: Upload results
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              continue-on-error: true
              with:
                  sarif_file: trivy-results.sarif

    build:
        name: Build Artifacts
        runs-on: ubuntu-latest
        needs: ci
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Build CLI binary
              run: deno compile --allow-read --allow-write --allow-net --output=hostlist-compiler src/cli.ts

            - name: Upload CLI binary
              uses: actions/upload-artifact@v4
              with:
                  name: hostlist-compiler-linux-x64
                  path: hostlist-compiler
                  retention-days: 30

    docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: ci
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository }}
                  tags: |
                      type=raw,value=latest,enable={{is_default_branch}}
                      type=sha,prefix=
                      type=ref,event=branch

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    publish:
        name: Publish to JSR
        runs-on: ubuntu-latest
        needs: ci
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Publish
              run: |
                  set -euo pipefail
                  # Attempt to publish to JSR. Capture output so we can inspect errors.
                  if ! OUTPUT="$(deno publish --allow-slow-types 2>&1)"; then
                    echo "${OUTPUT}"
                    # Treat "version already exists" style errors as non-fatal to preserve
                    # existing behavior, but fail on all other errors.
                    if echo "${OUTPUT}" | grep -qiE 'version .*already (exists|published)'; then
                      echo "Version may already exist; treating this as a non-fatal condition."
                      exit 0
                    fi
                    echo "deno publish failed with an unexpected error."
                    exit 1
                  fi

    deploy-worker:
        name: Deploy Cloudflare Worker
        runs-on: ubuntu-latest
        needs: [ci, security]
        if: |
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
            vars.ENABLE_CLOUDFLARE_DEPLOY == 'true'
        permissions:
            contents: read
        env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Install Wrangler
              run: npm install -g wrangler

            - name: Create Cloudflare resources
              run: |
                  # Create queues (ignore errors if they already exist)
                  wrangler queues create adblock-compiler-worker-queue 2>/dev/null || true
                  wrangler queues create adblock-compiler-worker-queue-high-priority 2>/dev/null || true
                  wrangler queues create adblock-compiler-dlq 2>/dev/null || true

                  # Create R2 bucket (ignore errors if it already exists)
                  wrangler r2 bucket create adblock-compiler-r2-storage 2>/dev/null || true

                  echo "Cloudflare resources ready"

            - name: Deploy Worker
              run: wrangler deploy

            - name: Post-deployment smoke test
              continue-on-error: true
              run: |
                  set -euo pipefail
                  sleep 10
                  SMOKE_TEST_URL="${{ vars.SMOKE_TEST_URL }}"
                  SMOKE_TEST_URL="${SMOKE_TEST_URL:-https://adblock-compiler.jayson-knight.workers.dev/api}"
                  RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$SMOKE_TEST_URL" || echo "000")
                  if [ "$RESPONSE" = "200" ]; then
                    echo "Smoke test passed - API responding"
                  else
                    echo "Warning: Smoke test returned HTTP $RESPONSE"
                  fi

    deploy-pages:
        name: Deploy Cloudflare Pages
        runs-on: ubuntu-latest
        needs: [ci, security]
        if: |
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
            vars.ENABLE_CLOUDFLARE_DEPLOY == 'true'
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Deploy
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: hostlist-compiler-ui
                  directory: public
