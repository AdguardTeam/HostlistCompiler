name: Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to release (e.g., 0.8.0)'
                required: true
                type: string

env:
    DENO_VERSION: '2.x'

permissions:
    contents: write
    packages: write

jobs:
    # Validate before building anything
    validate:
        name: Validate Release
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                      node_modules
                  key: deno-${{ runner.os }}-${{ hashFiles('deno.json', 'deno.lock') }}
                  restore-keys: |
                      deno-${{ runner.os }}-

            - name: Install dependencies
              run: deno install
              env:
                  DENO_TLS_CA_STORE: system

            - name: Run validation
              run: |
                  deno fmt --check
                  deno lint
                  deno check src/index.ts src/cli.ts
                  deno test --allow-read --allow-write --allow-net --allow-env

    build-binaries:
        name: Build ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        needs: validate
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      artifact: hostlist-compiler-linux-x64
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-latest
                      artifact: hostlist-compiler-linux-arm64
                    - target: x86_64-apple-darwin
                      os: macos-15-intel
                      artifact: hostlist-compiler-macos-x64
                    - target: aarch64-apple-darwin
                      os: macos-14
                      artifact: hostlist-compiler-macos-arm64
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      artifact: hostlist-compiler-windows-x64.exe
        steps:
            - uses: actions/checkout@v4

            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: ${{ env.DENO_VERSION }}

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: deno-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('deno.json', 'deno.lock') }}
                  restore-keys: |
                      deno-${{ runner.os }}-${{ matrix.target }}-
                      deno-${{ runner.os }}-

            - name: Build binary
              run: deno compile --allow-read --allow-write --allow-net --target ${{ matrix.target }} --output ${{ matrix.artifact }} src/cli.ts

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}
                  retention-days: 7

    build-docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: validate
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4

            - name: Get version
              id: version
              run: |
                  set -euo pipefail
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
                  else
                    echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
                  fi

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  # Multi-platform build includes ARM64 which uses QEMU emulation and builds slower
                  # To speed up builds, change to: platforms: linux/amd64
                  platforms: linux/amd64,linux/arm64
                  tags: |
                      ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
                      ghcr.io/${{ github.repository }}:latest
                  labels: |
                      org.opencontainers.image.version=${{ steps.version.outputs.version }}
                      org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    create-release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: [build-binaries, build-docker]
        steps:
            - uses: actions/checkout@v4

            - name: Get version
              id: version
              run: |
                  set -euo pipefail
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
                    echo "tag=v${{ inputs.version }}" >> "$GITHUB_OUTPUT"
                  else
                    echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
                    echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
                  fi

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release assets
              run: |
                  set -euo pipefail
                  mkdir -p release
                  # Copy all artifacts, preserving directory structure to avoid conflicts
                  for dir in artifacts/*/; do
                    artifact_name=$(basename "$dir")
                    if [ -f "$dir$artifact_name" ]; then
                      cp "$dir$artifact_name" "release/$artifact_name"
                    fi
                  done
                  ls -lah release/

            - name: Generate release notes
              id: notes
              run: |
                  set -euo pipefail
                  cat << 'EOF' > release-notes.md
                  ## What's Changed

                  See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for detailed changes.

                  ## Installation

                  ### JSR (Deno)
                  ```bash
                  deno add @jk-com/adblock-compiler
                  ```

                  ### Docker
                  ```bash
                  docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
                  ```

                  ### Binary Downloads
                  Download the appropriate binary for your platform from the assets below.

                  | Platform | Architecture | Download |
                  |----------|--------------|----------|
                  | Linux | x64 | `hostlist-compiler-linux-x64` |
                  | Linux | ARM64 | `hostlist-compiler-linux-arm64` |
                  | macOS | x64 (Intel) | `hostlist-compiler-macos-x64` |
                  | macOS | ARM64 (Apple Silicon) | `hostlist-compiler-macos-arm64` |
                  | Windows | x64 | `hostlist-compiler-windows-x64.exe` |

                  ## Checksums
                  ```
                  EOF
                  cd release
                  if [ -n "$(ls -A 2>/dev/null)" ]; then
                      sha256sum ./* >> ../release-notes.md 2>/dev/null || shasum -a 256 ./* >> ../release-notes.md
                  else
                      echo 'No binary artifacts were generated; no checksums available.' >> ../release-notes.md
                  fi
                  echo '```' >> ../release-notes.md

            - name: Create tag (workflow_dispatch only)
              if: github.event_name == 'workflow_dispatch'
              run: |
                  set -euo pipefail
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git fetch --tags
                  TAG_NAME="${{ steps.version.outputs.tag }}"
                  VERSION="${{ steps.version.outputs.version }}"
                  if [ -n "$(git tag -l \"$TAG_NAME\")" ]; then
                    echo "Tag $TAG_NAME already exists locally, skipping creation."
                  else
                    echo "Creating new tag $TAG_NAME for version $VERSION."
                    git tag -a "$TAG_NAME" -m "Release $VERSION"
                  fi
                  if git ls-remote --exit-code --tags origin "$TAG_NAME" >/dev/null 2>&1; then
                    echo "Tag $TAG_NAME already exists on origin, skipping push."
                  else
                    echo "Pushing tag $TAG_NAME to origin."
                    git push origin "$TAG_NAME"
                  fi

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: v${{ steps.version.outputs.version }}
                  body_path: release-notes.md
                  files: release/*
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.version, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
