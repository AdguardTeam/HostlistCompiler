services:
    # Main adblock-compiler service
    adblock-compiler:
        build:
            context: .
            dockerfile: Dockerfile
            target: runtime
        container_name: adblock-compiler
        ports:
            - '${PORT:-8787}:8787'
        env_file:
            # Load environment variables in layered order
            - .env # Base configuration
            - .env.${ENV:-development} # Environment-specific (development by default)
        # .env.local is excluded from Docker builds (in .dockerignore)
        # Pass secrets via docker-compose.override.yml or -e flags
        environment:
            # Override/add any environment-specific variables here
            - DENO_DIR=/app/.deno
        volumes:
            # Persist Deno cache
            - deno-cache:/app/.deno
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8787/api']
            interval: 30s
            timeout: 3s
            retries: 3
            start_period: 5s
        networks:
            - adblock-network

volumes:
    deno-cache:
        name: adblock-compiler-deno-cache

networks:
    adblock-network:
        name: adblock-compiler-network
        driver: bridge
