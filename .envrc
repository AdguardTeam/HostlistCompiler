# ==============================
# Universal direnv dotenv loader (Zsh layered merge)
# ==============================

# Watch for changes in env files
watch_file .env .env.local .env.development .env.production

# If inside a Git repo, also watch branch changes
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  watch_file "$(git rev-parse --show-toplevel)/.git/HEAD"
  
  # Detect current branch
  GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "default")
  
  # Map branch to ENV
  case "$GIT_BRANCH" in
    main|master)
      ENV="production"
      ;;
    develop|dev)
      ENV="development"
      ;;
    *)
      if [[ -f ".env.$GIT_BRANCH" ]]; then
        ENV="$GIT_BRANCH"
      else
        ENV="local"
      fi
      ;;
  esac
else
  ENV="development"
  GIT_BRANCH="(no-git)"
fi

# Function to load env vars without clearing existing ones
load_env_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    # Export each non-comment, non-empty line
    while IFS='=' read -r key value; do
      [[ -z "$key" || "$key" == \#* ]] && continue
      export "$key"="$value"
    done < "$file"
  fi
}

# Load files in layered order
load_env_file ".env"
load_env_file ".env.$ENV"
load_env_file ".env.local"

# Status message
echo "âœ… Loaded environment: $ENV (branch: $GIT_BRANCH)"
