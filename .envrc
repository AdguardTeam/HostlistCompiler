# ==============================
# Universal direnv dotenv loader (Zsh layered merge)
# ==============================

# Watch for changes in env files
watch_file .env .env.local .env.development .env.production

# If inside a Git repo, also watch branch changes
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  watch_file "$(git rev-parse --show-toplevel)/.git/HEAD"
  
  # Detect current branch
  GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "default")
  
  # Map branch to ENV
  case "$GIT_BRANCH" in
    main)
      ENV="production"
      ;;
    develop|dev)
      ENV="development"
      ;;
    *)
      if [[ -f ".env.$GIT_BRANCH" ]]; then
        ENV="$GIT_BRANCH"
      else
        ENV="local"
      fi
      ;;
  esac
else
  ENV="development"
  GIT_BRANCH="(no-git)"
fi

# Load env vars using direnv's built-in dotenv loader (preserves proper quoting/escaping)
# Files are loaded in a layered order without clearing existing variables.

# Load files in layered order
dotenv_if_exists ".env"
dotenv_if_exists ".env.$ENV"
dotenv_if_exists ".env.local"

# Status message
echo "âœ… Loaded environment: $ENV (branch: $GIT_BRANCH)"
